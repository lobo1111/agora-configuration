<?xml version="1.0" encoding="UTF-8"?> 
<databaseChangeLog 
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog/1.9" 
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog/1.9
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd"> 
    <changeSet author='tkopacki' id='bank-table'>
        <sql> 
            CREATE TABLE IF NOT EXISTS `bank` (
            `id` int(11) NOT NULL AUTO_INCREMENT,
            `name` varchar(150) COLLATE utf8_polish_ci NOT NULL,
            PRIMARY KEY (`id`)
            ) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_polish_ci AUTO_INCREMENT=1 ;
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='account-add-bank-column'>
        <sql>  
            ALTER TABLE `account` 
            ADD `bank_id` int(11) NOT NULL
        </sql>
    </changeSet>  
    
    <changeSet author='tkopacki' id='account-bank-fkey'>
        <sql> 
            ALTER TABLE `account`
            ADD CONSTRAINT `bank_id_fkey` FOREIGN KEY (`bank_id`) REFERENCES `bank` (`id`) ON DELETE NO ACTION ON UPDATE NO ACTION;
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='bank-add-key-column'>
        <sql>  
            ALTER TABLE `bank` 
            ADD `bankKey` varchar(150) NOT NULL
        </sql>
    </changeSet> 
    
    <changeSet author='tkopacki' id='bank-pocztowy-insert'>
        <sql> 
            INSERT INTO `bank` (`name`, `bankKey`) VALUES ('Bank Pocztowy', 'BANK_POCZTOWY');
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='bank-pocztowy-account-insert'>
        <sql> 
            INSERT INTO `account` (`bank_id`, `name`, `number`)
            SELECT id, 'Bank Pocztowy - konto główne', '321421343214324' FROM `bank` WHERE `bankKey` = 'BANK_POCZTOWY'
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='dictionary-account-type'>
        <sql>
            INSERT INTO `dictionary_type` (`type`) VALUES
            ('ACCOUNT_TYPE');
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='accounts-types'>
        <sql>
            INSERT INTO `dictionary` (`type_id`, `dictionaryKey`, `value`)
            SELECT id, 'DEFAULT', 'Konto ogólne' FROM `dictionary_type` WHERE `type` = 'ACCOUNT_TYPE';
            
            INSERT INTO `dictionary` (`type_id`, `dictionaryKey`, `value`)
            SELECT id, 'RENT', 'Konto czynszowe' FROM `dictionary_type` WHERE `type` = 'ACCOUNT_TYPE';
            
            INSERT INTO `dictionary` (`type_id`, `dictionaryKey`, `value`)
            SELECT id, 'REPAIR_FUND', 'Fundusz remontowy' FROM `dictionary_type` WHERE `type` = 'ACCOUNT_TYPE';
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='account-add-type-column'>
        <sql>  
            ALTER TABLE `account` 
            ADD `type_id` int(11) NOT NULL;
        </sql>
    </changeSet>  
    
    <changeSet author='tkopacki' id='account-update-types'>
        <sql>  
            UPDATE `account` SET type_id = (SELECT id FROM `dictionary` WHERE dictionaryKey = 'DEFAULT');
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='account-type-fkey'>
        <sql>  
            ALTER TABLE `account`
            ADD CONSTRAINT `account_type_fkey` FOREIGN KEY (`type_id`) REFERENCES `dictionary` (`id`) ON DELETE NO ACTION ON UPDATE NO ACTION;
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='payment-table'>
        <sql> 
            CREATE TABLE IF NOT EXISTS `payment` (
            `id` int(11) NOT NULL AUTO_INCREMENT,
            `possession_id` int(11) NOT NULL,
            `type_id` int(11) NOT NULL,
            `status_id` int(11) NOT NULL,
            `income` decimal(10,2) DEFAULT NULL,
            `description` varchar(255) COLLATE utf8_polish_ci NOT NULL,
            `auto` int(1) NOT NULL DEFAULT 0,
            PRIMARY KEY (`id`)
            ) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_polish_ci AUTO_INCREMENT=1 ;
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='payment-possession-fkey'>
        <sql>  
            ALTER TABLE `payment`
            ADD CONSTRAINT `possession_fkey` FOREIGN KEY (`possession_id`) REFERENCES `possession` (`id`) ON DELETE NO ACTION ON UPDATE NO ACTION;
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='payment-type-fkey'>
        <sql>  
            ALTER TABLE `payment`
            ADD CONSTRAINT `payment_type_fkey` FOREIGN KEY (`type_id`) REFERENCES `dictionary` (`id`) ON DELETE NO ACTION ON UPDATE NO ACTION;
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='payment-status-fkey'>
        <sql>  
            ALTER TABLE `payment`
            ADD CONSTRAINT `payment_status_fkey` FOREIGN KEY (`status_id`) REFERENCES `dictionary` (`id`) ON DELETE NO ACTION ON UPDATE NO ACTION;
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='payment-type'>
        <sql>
            INSERT INTO `dictionary_type` (`type`) VALUES
            ('PAYMENT_TYPE');
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='payments-types-insert'>
        <sql>
            INSERT INTO `dictionary` (`type_id`, `dictionaryKey`, `value`)
            SELECT id, 'RENT', 'Czynsz' FROM `dictionary_type` WHERE `type` = 'PAYMENT_TYPE';
            
            INSERT INTO `dictionary` (`type_id`, `dictionaryKey`, `value`)
            SELECT id, 'REPAIR_FUND', 'Fundusz remontowy' FROM `dictionary_type` WHERE `type` = 'PAYMENT_TYPE';
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='payment-status'>
        <sql>
            INSERT INTO `dictionary_type` (`type`) VALUES
            ('PAYMENT_STATUS');
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='payments-statuses-insert'>
        <sql>
            INSERT INTO `dictionary` (`type_id`, `dictionaryKey`, `value`)
            SELECT id, 'NEW_PAYMENT', 'Nowa płatność' FROM `dictionary_type` WHERE `type` = 'PAYMENT_STATUS';
            
            INSERT INTO `dictionary` (`type_id`, `dictionaryKey`, `value`)
            SELECT id, 'BOOKED', 'Zaksięgowana' FROM `dictionary_type` WHERE `type` = 'PAYMENT_STATUS';
            
            INSERT INTO `dictionary` (`type_id`, `dictionaryKey`, `value`)
            SELECT id, 'CANCELED', 'Anulowana' FROM `dictionary_type` WHERE `type` = 'PAYMENT_STATUS';
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='payment-income-not-null'>
        <sql>  
            ALTER TABLE `payment`
            MODIFY `income` decimal(10,2) NOT NULL;
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='payment-description-null'>
        <sql>  
            ALTER TABLE `payment`
            MODIFY `description` varchar(255) NULL;
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='zpk-table'>
        <sql> 
            CREATE TABLE IF NOT EXISTS `zpk` (
            `id` int(11) NOT NULL AUTO_INCREMENT,
            `number` varchar(150) COLLATE utf8_polish_ci NOT NULL,
            `description` varchar(255) COLLATE utf8_polish_ci,
            `community_id` int(11) NOT NULL,
            `possession_id` int(11) NULL,
            `type_id` int(11) NOT NULL,
            `credit` decimal(10,2) DEFAULT 0,
            `debit` decimal(10,2) DEFAULT 0,
            PRIMARY KEY (`id`)
            ) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_polish_ci AUTO_INCREMENT=1 ;
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='zpk-community-fkey'>
        <sql>  
            ALTER TABLE `zpk`
            ADD CONSTRAINT `zpk_community_fkey` FOREIGN KEY (`community_id`) REFERENCES `community` (`id`) ON DELETE NO ACTION ON UPDATE NO ACTION;
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='zpk-possession-fkey'>
        <sql>  
            ALTER TABLE `zpk`
            ADD CONSTRAINT `zpk_possession_fkey` FOREIGN KEY (`possession_id`) REFERENCES `possession` (`id`) ON DELETE NO ACTION ON UPDATE NO ACTION;
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='zpk-type-fkey'>
        <sql>  
            ALTER TABLE `zpk`
            ADD CONSTRAINT `zpk_type_fkey` FOREIGN KEY (`type_id`) REFERENCES `dictionary` (`id`) ON DELETE NO ACTION ON UPDATE NO ACTION;
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='zpk-credit-debit-remove'>
        <sql>  
            ALTER TABLE `zpk`
            DROP COLUMN credit;
            ALTER TABLE `zpk`
            DROP COLUMN debit;
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='payment-auto-removed'>
        <sql>  
            ALTER TABLE `payment`
            DROP COLUMN auto;
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='payment-booked-balance-columns-add'>
        <sql>  
            ALTER TABLE `payment`
            ADD COLUMN booked boolean DEFAULT false;
            ALTER TABLE `payment`
            ADD COLUMN create_day date DEFAULT NULL;
            ALTER TABLE `payment`
            ADD COLUMN booking_day date DEFAULT NULL;
            ALTER TABLE `payment`
            ADD COLUMN balance_id int(11) NULL;
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='table-zpk-balance'>
        <sql>  
            CREATE TABLE IF NOT EXISTS `zpk_balance` (
            `id` int(11) NOT NULL AUTO_INCREMENT,
            `credit` decimal(10,2) DEFAULT 0,
            `debit` decimal(10,2) DEFAULT 0,
            `start_credit` decimal(10,2) DEFAULT 0,
            `start_debit` decimal(10,2) DEFAULT 0,
            `zpk_id` int(11) NOT NULL,
            `booking_period_id` int(11) NOT NULL,
            PRIMARY KEY (`id`)
            ) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_polish_ci AUTO_INCREMENT=1 ;
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='table0booking-period'>
        <sql>  
            CREATE TABLE IF NOT EXISTS `booking_period` (
            `id` int(11) NOT NULL AUTO_INCREMENT,
            `default` boolean DEFAULT false,
            `name`  varchar(255) COLLATE utf8_polish_ci,
            `active` boolean DEFAULT true,
            PRIMARY KEY (`id`)
            ) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_polish_ci AUTO_INCREMENT=1 ;
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='payment-zpk-balance-fkey'>
        <sql>  
            ALTER TABLE `payment`
            ADD CONSTRAINT `payment_zbk_balance_fkey` FOREIGN KEY (`balance_id`) REFERENCES `zpk_balance` (`id`) ON DELETE NO ACTION ON UPDATE NO ACTION;            
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='zpk-balance-zpk-fkey'>
        <sql>  
            ALTER TABLE `zpk_balance`
            ADD CONSTRAINT `zbk_balance_zpk_fkey` FOREIGN KEY (`zpk_id`) REFERENCES `zpk` (`id`) ON DELETE NO ACTION ON UPDATE NO ACTION;            
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='zpk-balance-booking-period-fkey'>
        <sql>  
            ALTER TABLE `zpk_balance`
            ADD CONSTRAINT `zbk_balance_booking_period_fkey` FOREIGN KEY (`booking_period_id`) REFERENCES `booking_period` (`id`) ON DELETE NO ACTION ON UPDATE NO ACTION;            
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='zpk-type-column-drop'>
        <sql> 
            ALTER TABLE `zpk` DROP FOREIGN KEY `zpk_type_fkey`;
            ALTER TABLE `zpk` DROP COLUMN `type_id`;
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='zpk-default-booking-period'>
        <sql> 
            INSERT INTO `booking_period`(`default`, `name`, `active`) VALUES(true, 'domyślny', true);
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='drop-possession-account'>
        <sql> 
            DROP TABLE `possession_account;
        </sql>
    </changeSet>
        
    <changeSet author='tkopacki' id='zpk-person-column'>
        <sql> 
            ALTER TABLE `zpk`
            ADD COLUMN `person_id` int(11); 
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='zpk-company-column'>
        <sql> 
            ALTER TABLE `zpk`
            ADD COLUMN `company_id` int(11); 
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='zpk-person-fkey'>
        <sql>  
            ALTER TABLE `zpk`
            ADD CONSTRAINT `zbk_person_fkey` FOREIGN KEY (`person_id`) REFERENCES `person` (`id`) ON DELETE NO ACTION ON UPDATE NO ACTION;            
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='zpk-company-fkey'>
        <sql>  
            ALTER TABLE `zpk`
            ADD CONSTRAINT `zbk_company_fkey` FOREIGN KEY (`company_id`) REFERENCES `company` (`id`) ON DELETE NO ACTION ON UPDATE NO ACTION;            
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='booking-period-refactoring'>
        <sql>  
            ALTER TABLE `booking_period` CHANGE `default` `default_period` boolean;
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='bank-company-column'>
        <sql>  
            ALTER TABLE `bank` 
            ADD `company_id` int(11) NOT NULL
        </sql>
    </changeSet>  
    
    <changeSet author='tkopacki' id='bank-company-fkey'>
        <sql>  
            ALTER TABLE `bank`
            ADD CONSTRAINT `bank_company_fkey` FOREIGN KEY (`company_id`) REFERENCES `company` (`id`) ON DELETE NO ACTION ON UPDATE NO ACTION;            
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='payment-account-column'>
        <sql>  
            ALTER TABLE `payment` 
            ADD `account_id` int(11) NOT NULL
        </sql>
    </changeSet> 
    
    <changeSet author='tkopacki' id='payment-account-column-fkey'>
        <sql>  
            ALTER TABLE `payment`
            ADD CONSTRAINT `payment_account_column_fkey` FOREIGN KEY (`account_id`) REFERENCES `account` (`id`) ON DELETE NO ACTION ON UPDATE NO ACTION;            
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='payment-possession-column-fkey-drop'>
        <sql>  
            ALTER TABLE `payment` DROP FOREIGN KEY `possession_fkey`;
            ALTER TABLE `payment` DROP COLUMN `possession_id`;
        </sql>
    </changeSet> 
    
    <changeSet author='tkopacki' id='payment-direction-column'>
        <sql>
            ALTER TABLE `payment` ADD COLUMN `direction` enum('INCOME', 'EXPENDITURE') NOT NULL DEFAULT 'INCOME',
        </sql>
    </changeSet>
    
</databaseChangeLog>