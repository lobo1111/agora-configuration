<?xml version="1.0" encoding="UTF-8"?> 
<databaseChangeLog 
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog/1.9" 
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog/1.9
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd"> 
    <changeSet author='tkopacki' id='scripts'>
        <sql>   
            CREATE TABLE IF NOT EXISTS `script` (
            `id` int(11) NOT NULL AUTO_INCREMENT,
            `name` varchar(45) COLLATE utf8_polish_ci NOT NULL,
            `script` text COLLATE utf8_polish_ci,
            `on_init` text COLLATE utf8_polish_ci,
            `base` tinyint(1) DEFAULT '0',
            `parent` int(11) DEFAULT NULL,
            PRIMARY KEY (`id`),
            UNIQUE KEY `name_UNIQUE` (`name`),
            KEY `script_parent_fkey` (`parent`)
            ) ENGINE=InnoDB  DEFAULT CHARSET=utf8 COLLATE=utf8_polish_ci AUTO_INCREMENT=6 ;

            CREATE TABLE IF NOT EXISTS `script_scheduler` (
            `id` int(11) NOT NULL AUTO_INCREMENT,
            `name` varchar(45) COLLATE utf8_polish_ci NOT NULL,
            `id_script` int(11) NOT NULL,
            `enabled` tinyint(1) NOT NULL,
            `schedule` varchar(45) COLLATE utf8_polish_ci NOT NULL,
            PRIMARY KEY (`id`),
            UNIQUE KEY `name_UNIQUE` (`name`),
            KEY `scheduler_script_fkey` (`id_script`)
            ) ENGINE=InnoDB  DEFAULT CHARSET=utf8 COLLATE=utf8_polish_ci AUTO_INCREMENT=3 ;
            
            
            ALTER TABLE `script`
            ADD CONSTRAINT `script_parent_fkey` FOREIGN KEY (`parent`) REFERENCES `script` (`id`) ON DELETE NO ACTION ON UPDATE NO ACTION;

            ALTER TABLE `script_scheduler`
            ADD CONSTRAINT `scheduler_script_fkey` FOREIGN KEY (`id_script`) REFERENCES `script` (`id`) ON DELETE NO ACTION ON UPDATE NO ACTION;
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='outputScript'>
        <sql>
            INSERT INTO `script` (`id`, `name`, `script`, `on_init`, `base`, `parent`) VALUES
            (7, 'Output', 'class Output:\r\n  _result = ''''\r\n\r\n  def getResult(self):\r\n    return self._result\r\n\r\n  def setResult(self, result):\r\n    self._result = result\r\n\r\n  def appendResult(self, result):\r\n    self._result += result', 'output = Output()', 1, NULL);
        </sql>
    </changeSet>
    
    <changeSet author='tkopacki' id='DBLoggerScript'>
        <sql>
            INSERT INTO `script` (`id`, `name`, `script`, `on_init`, `base`, `parent`) VALUES
            (6, 'DBLogger', 'from pl.reaper.container.data import Log\r\n\r\nclass Logger:\r\n  def appendLog(self, level, message):\r\n    log = Log()\r\n    log.setScriptId(vars.get(''_scriptId''))\r\n    log.setLevel(level)\r\n    log.setMessage(message)\r\n    entityManager.persist(log)\r\n\r\n  def info(self, message):\r\n    self.appendLog(''INFO'', message)\r\n\r\n  def warn(self, message):\r\n    self.appendLog(''WARNING'', message)\r\n\r\n  def error(self, message):\r\n    self.appendLog(''ERROR'', message)', 'logger = Logger()', 1, NULL);
        </sql>
    </changeSet>
        
    <changeSet author='tkopacki' id='DBLoggerScript-added-thread-columns-support'>
        <sql>
            UPDATE `script` SET  `script` =  'from pl.reaper.container.data import Log
class Logger:
  def appendLog(self, level, message):
    log = Log()
    log.setScriptId(vars.get(''_scriptId''))
    log.setThreadId(vars.get(''_threadId''))
    log.setThreadName(vars.get(''_threadName''))
    log.setLevel(level)
    log.setMessage(message)
    entityManager.persist(log)

  def info(self, message):
    self.appendLog(''INFO'', message)

  def warn(self, message):
    self.appendLog(''WARNING'', message)

  def error(self, message):
    self.appendLog(''ERROR'', message)' WHERE  `script`.`name` = 'DBLogger';
        </sql>
    </changeSet>
</databaseChangeLog>